services:
  postgresql:
    image: postgres:17-alpine
    container_name: mortise-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: mortise
      POSTGRES_PASSWORD: XzHvhX4CDaN696oQAXdmlcsrqgWbkxRl
      POSTGRES_DB: postgres
      TZ: Asia/Shanghai
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U postgres' ]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432"
    volumes:
      - ./app/postgresql/data:/var/lib/postgresql/data
      - ./app/postgresql/logs:/var/log/postgresql
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
  redis:
    image: 'redis:7.0.8'
    container_name: mortise-redis
    restart: unless-stopped
    sysctls:
      - net.core.somaxconn=1024
    ports:
      - "6379:6379"
    volumes:
      - ./app/redis:/data
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass d9d2j9w2 --appendonly yes
    environment:
      TZ: Asia/Shanghai
  logto:
    image: svhd/logto
    container_name: mortise-logto
    restart: unless-stopped
    ports:
      - '3010:3010'
      - '3011:3011'
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      INTEGRATION_TEST: TRUE
      TRUST_PROXY_HEADER: 1
      DB_URL: postgresql://mortise:XzHvhX4CDaN696oQAXdmlcsrqgWbkxRl@postgresql:5432/logto
      PORT: 3010
      ADMIN_PORT: 3011
      ENDPOINT: https://auth.rymcu.local
      ADMIN_ENDPOINT: https://logto.rymcu.local
    entrypoint: ['sh', '-c', 'npm run cli db seed -- --swe && npm start']
  app:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: npm
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    volumes:
      - ./app/npm/data:/data
      - ./app/npm/letsencrypt:/etc/letsencrypt
    environment:
      # Postgres parameters:
      DB_POSTGRES_HOST: 'db'
      DB_POSTGRES_PORT: '5432'
      DB_POSTGRES_USER: 'npm'
      DB_POSTGRES_PASSWORD: 'XzHvhX4CDaN696oQAXdmlcsrqgWbkxRl'
      DB_POSTGRES_NAME: 'npm'
      # Uncomment this if IPv6 is not enabled on your host
      # DISABLE_IPV6: 'true'
      TZ: Asia/Shanghai
    depends_on:
      - db
  db:
    image: postgres:17-alpine
    container_name: npm-db
    environment:
      POSTGRES_USER: 'npm'
      POSTGRES_PASSWORD: 'XzHvhX4CDaN696oQAXdmlcsrqgWbkxRl'
      POSTGRES_DB: 'npm'
    volumes:
      - ./app/npm/postgres:/var/lib/postgresql/data
