spring:
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html
    mode: HTML5
    encoding: UTF-8
    servlet:
      content-type: text/html
    cache: false
  data:
    redis:
      host: 192.168.88.243
      port: 6379
      password:
      database: 1
      timeout: 3000
      jedis:
        pool:
          max-active: 8
          max-wait: 1
          max-idle: 500
          min-idle: 0
  datasource:
    url: jdbc:postgresql://192.168.88.243:15432/postgres
    username: mortise
    password: ENC(/T9oN1+Zyq6ZOYV4oOyJJFblmrbhla0tmI1ExpjXA/4cg1gw+Yh6kw==)
    driver-class-name: org.postgresql.Driver
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 连接相关配置
      connection-timeout: 20000          # 连接超时时间(ms) - 降低到20秒
      idle-timeout: 300000               # 空闲连接超时时间(ms) - 5分钟
      max-lifetime: 1200000              # 连接最大生命周期(ms) - 20分钟
      maximum-pool-size: 20              # 最大连接池大小 - 增加到20
      minimum-idle: 8                    # 最小空闲连接数 - 增加到8
      pool-name: mortisePool
      connection-test-query: SELECT 1
      schema: mortise

      # 性能和监控配置
      register-mbeans: true              # 启用JMX监控
      leak-detection-threshold: 30000    # 连接泄露检测阈值(ms) - 30秒
      validation-timeout: 5000           # 连接验证超时(ms)

      # PostgreSQL 特定优化
      data-source-properties:
        cachePrepStmts: true             # 启用预编译语句缓存
        prepStmtCacheSize: 250           # 预编译语句缓存大小
        prepStmtCacheSqlLimit: 2048      # 预编译语句最大长度
        useServerPrepStmts: true         # 使用服务器端预编译语句
        useLocalSessionState: true       # 使用本地会话状态
        rewriteBatchedStatements: true   # 重写批量语句
        cacheResultSetMetadata: true     # 缓存结果集元数据
        cacheServerConfiguration: true   # 缓存服务器配置
        elideSetAutoCommits: true        # 优化自动提交设置
        maintainTimeStats: false         # 禁用时间统计(性能优化)

  # Flyway 数据库迁移配置
  flyway:
    enabled: true                        # 启用 Flyway
    baseline-on-migrate: true            # 如果数据库不是空的，首次迁移时自动创建基线
    baseline-version: 0                  # 基线版本号
    locations: classpath:db/migration    # SQL脚本位置（自动扫描所有 classpath JAR 中的 db/migration）
    encoding: UTF-8                      # SQL脚本编码
    validate-on-migrate: true            # 迁移前验证SQL脚本
    out-of-order: true                   # 允许乱序迁移（商业模块 V100+ 需要）
    clean-disabled: true                 # 禁用clean命令（生产环境必须禁用）
    schemas: mortise                     # 指定schema
    create-schemas: false                # 尝试创建 schema（生产环境必须禁用）
    table: flyway_schema_history         # 迁移历史记录表名
    ignore-migration-patterns: "*:*"     # 忽略所有迁移的校验和不匹配问题（开发环境用）
    placeholder-replacement: true        # 启用占位符替换
    sql-migration-prefix: V              # SQL迁移脚本前缀
    sql-migration-separator: __          # SQL迁移脚本分隔符
    sql-migration-suffixes: .sql         # SQL迁移脚本后缀

  mail:
    host: smtp.larksuite.com
    port: 465
    person: ATDAK
    username: services@atdak.com
    password: ENC(EBe9Le3JmVqg5iEvu9jMGTg33rBDoX5qocVTkrjyKyTU8XcH7ht2aQ==)
    protocol: smtp
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true
            trust: "*"
          socketFactory:
            port: 465
            class: javax.net.ssl.SSLSocketFactory
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB

logging:
  file:
    path: /logs/mortise
  level:
    com:
      rymcu: info

# Spring Boot Actuator 增强配置
management:
  endpoints:
    web:
      exposure:
        # 暴露所有监控端点，生产环境建议只暴露必要的端点
        include: "health,ratelimiters,info"
        # 排除敏感端点（可根据需要调整）
        exclude: shutdown
      base-path: /actuator
      # 跨域配置
      cors:
        allowed-origins: "*"
        allowed-methods: GET,POST
  endpoint:
    # 健康检查详细信息
    health:
      show-details: always
      show-components: always
      # 健康检查组配置
      group:
        readiness:
          include: db,redis
        liveness:
          include: diskSpace,ping
    # 启用环境信息
    env:
      show-values: when-authorized
    # 配置信息
    configprops:
      show-values: when-authorized
  # 指标配置
  metrics:
    enable:
      # JVM指标
      jvm: true
      # 系统指标
      system: true
      # Web指标
      web: true
      # 数据库指标
      jdbc: true
      # 缓存指标
      cache: true
    # 自定义标签
    tags:
      application: mortise
      environment: dev
      version: 0.0.1
      team: backend
    # Web指标配置
    web:
      server:
        # 最大URI数量，防止标签爆炸
        max-uri-tags: 100
    # 分布追踪配置
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
  # 应用信息配置
  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true
    # Git信息（需要git-commit-id-plugin）
    git:
      enabled: true
      mode: full
    # 构建信息
    build:
      enabled: true
  # 审计配置
  auditevents:
    enabled: true
  # Prometheus 指标配置
  prometheus:
    metrics:
      export:
        enabled: true

# Resilience4j 标准配置
resilience4j:
  ratelimiter:
    configs:
      default:
        limit-for-period: 10
        limit-refresh-period: 1s
        timeout-duration: 100ms
        register-health-indicator: true
        event-consumer-buffer-size: 50
      strict:
        limit-for-period: 5
        limit-refresh-period: 1s
        timeout-duration: 50ms
        register-health-indicator: true
        event-consumer-buffer-size: 50
      loose:
        limit-for-period: 50
        limit-refresh-period: 1s
        timeout-duration: 200ms
        register-health-indicator: true
        event-consumer-buffer-size: 50
    instances:
      # 预定义一些限流器实例，这样 actuator 就能看到它们
      auth-login:
        base-config: strict
        limit-for-period: 5
        limit-refresh-period: 300s
      auth-register:
        base-config: strict
        limit-for-period: 3
        limit-refresh-period: 600s
      api-default:
        base-config: default

# 应用信息
info:
  app:
    name: Mortise
    description: 一款现代化的后台管理脚手架项目
    version: ${project.version:0.0.1}
    encoding: ${project.build.sourceEncoding:UTF-8}
    java:
      version: ${java.version:21}

server:
  port: 9999
  servlet:
    context-path: /mortise
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 10240
  max-http-request-header-size: 10240
baseUrl: https://atdak.com

# JWT 配置
jwt:
  secret: ${JWT_SECRET:w0gADMTuedSB1PS4f59vwJaOV7n2fYcAAAAhALwcBo1hcJ8ELdByH/qcmQ1fWKK7}
  expiration: 3600000  # 1小时，单位毫秒
  header: Authorization  # Token 请求头名称
  token-prefix: "Bearer "  # Token 前缀（注意有空格）
  refresh-window: 300000   # 5 分钟

executor:
  thread:
    async:
      corePoolSize: 4 # 可以根据 CPU 核心数来估算
      maxPoolSize: 8 # 通常设置为 corePoolSize 的 2-3 倍
      queueCapacity: 100 # 根据内存和业务容忍度选择
      keepAliveSeconds: 60
      name:
        prefix: mortise-async-executor
mybatis-flex:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.rymcu.mortise.system.entity,com.rymcu.mortise.member.entity,com.rymcu.mortise.product.entity,com.rymcu.mortise.commerce.entity,com.rymcu.mortise.payment.entity
  configuration:
    # 开启驼峰命名自动映射
    map-underscore-to-camel-case: true
    # 配置默认的执行器。SIMPLE-普通执行器；REUSE-重用预处理语句；BATCH-批量更新执行器
    default-executor-type: reuse
    # 开启二级缓存
    cache-enabled: true
    # 开启延迟加载
    lazy-loading-enabled: true
    # 延迟加载的触发方法
    lazy-load-trigger-methods: equals,clone,hashCode,toString
    # 当开启时，任何方法的调用都会触发延迟加载对象的完整加载
    aggressive-lazy-loading: false
    # 设置超时时间(秒)
    default-statement-timeout: 30
    # 设置获取数据的默认条数，提升批量查询性能
    default-fetch-size: 100
    # 允许在嵌套语句中使用分页
    safe-row-bounds-enabled: true
    # 允许在嵌套语句中使用结果映射
    safe-result-handler-enabled: true
    # 注意：不要开启 use-generated-keys，它会与 MyBatis-Flex 的 KeyGenerators 冲突
    # use-generated-keys: true
    # 本地缓存机制，防止循环引用和加速重复嵌套查询
    local-cache-scope: SESSION
  global-config:
    # 关闭 Banner 打印
    print-banner: false
    # 逻辑删除配置
    logic-delete-column: del_flag

# SpringDoc OpenAPI 配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /index.html
    operations-sorter: alpha
    tags-sorter: alpha
  show-actuator: false
  writer-with-default-pretty-printer: true
  default-consumes-media-type: application/json
  default-produces-media-type: application/json
  group-configs:
    - group: 'auth'
      display-name: '认证接口'
      paths-to-match: '/api/v1/auth/**'
    - group: 'admin'
      display-name: '管理接口'
      paths-to-match: '/api/v1/admin/**'
    - group: 'system-init'
      display-name: '系统初始化接口'
      paths-to-match: '/api/v1/system-init/**'
    - group: 'wechat'
      display-name: '微信服务接口'
      paths-to-match: '/api/v1/wechat/**'
    - group: 'edu'
      display-name: '在线教育接口'
      paths-to-match: '/api/v1/edu/**'
    - group: 'vod'
      display-name: '视频点播接口'
      paths-to-match: '/api/v1/vod/**'
    - group: 'app'
      display-name: 'app 端接口'
      paths-to-match: '/api/v1/app/**'
    - group: 'product'
      display-name: '商品管理接口'
      paths-to-match: '/api/v1/admin/product/**,/api/v1/app/products/**'
    - group: 'commerce'
      display-name: '订单商务接口'
      paths-to-match: '/api/v1/admin/commerce/**,/api/v1/app/orders/**'
    - group: 'pay'
      display-name: '支付网关接口'
      paths-to-match: '/app/pay/**,/pay/**'
    - group: 'file'
      display-name: '文件上传接口'
      paths-to-match: '/api/v1/files/**'

# x-file-storage 文件存储配置
dromara:
  x-file-storage:
    default-platform: local-plus-1
    # 缩略图后缀，例如【.min】，则缩略图为【xxx.min.jpg】
    thumbnail-suffix: .min
    local-plus:
      - platform: local-plus-1
        enable-storage: true
        enable-access: true
        domain: /files/ # 访问域名，例如："http://127.0.0.1:8030/file/"，注意后面要和 path-patterns 保持一致，"/"结尾，本地存储建议使用相对路径，方便后期更换域名
        base-path: local-plus/ # 基础路径
        path-patterns: /files/** # 访问路径
        storage-path: /app/files/ # 存储路径
mortise:
  github:
    api-base-url: https://api.github.com
    token: ${GITHUB_TOKEN:}  # GitHub Personal Access Token（需要 repo admin 权限）
  auth:
    sms:
      login-url: /api/v1/auth/login/sms
      mobile-parameter: mobile
      code-parameter: smsCode
      user-type-parameter: userType
      post-only: true
