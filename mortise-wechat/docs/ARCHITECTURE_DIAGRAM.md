# WeChat 模块架构演进图

## 重构前架构（混乱）

```
┌─────────────────────────────────────────────────────────────┐
│                        Controller 层                         │
│  WeChatAccountController  │  WeChatConfigController  │ ...   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Service 层                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ WeChatConfigService (旧表结构)                        │  │
│  │ - 单账号配置加载                                       │  │
│  │ - 基于 config_type                                    │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ WeChatConfigManagementService                         │  │
│  │ - 简单 CRUD                                           │  │
│  │ - 职责重叠 ❌                                         │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ WeChatAccountManagementService                        │  │
│  │ - 账号 + 配置管理                                     │  │
│  │ - 功能分散 ❌                                         │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ WeChatMultiAccountConfigService (新表结构)            │  │
│  │ - 多账号配置加载                                       │  │
│  │ - 新旧共存 ❌                                         │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Mapper 层                            │
│  WeChatAccountMapper  │  WeChatConfigMapper                  │
└─────────────────────────────────────────────────────────────┘

问题：
  ❌ 4个Service职责重叠
  ❌ 新旧架构共存
  ❌ 缺少统一规范
  ❌ 没有分页支持
  ❌ 代码重复严重
```

## 重构后架构（清晰）

```
┌──────────────────────────────────────────────────────────────────────┐
│                            Controller 层                              │
│  ┌────────────────┐  ┌─────────────────┐  ┌──────────────────────┐  │
│  │  Account       │  │  Login          │  │  Message │  Portal   │  │
│  │  /accounts     │  │  /login         │  │  /messages│ /portal  │  │
│  └────────────────┘  └─────────────────┘  └──────────────────────┘  │
│         │                    │                      │        │        │
│         │  GlobalResult      │  GlobalResult        │        │        │
│         │  分页支持 ✅       │  文档完善 ✅         │        │        │
└──────────────────────────────────────────────────────────────────────┘
          │                    │                      │        │
          └────────────────────┴──────────────────────┴────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                          Service 接口层                               │
│  ┌──────────────────────────────┐  ┌──────────────────────────────┐ │
│  │  WeChatAccountService        │  │  WeChatConfigService         │ │
│  │  ┌────────────────────────┐  │  │  ┌────────────────────────┐  │ │
│  │  │ 账号管理               │  │  │  │ 配置加载               │  │ │
│  │  │ • pageAccounts()       │  │  │  │ • loadMpConfig()       │  │ │
│  │  │ • createAccount()      │  │  │  │ • loadOpenConfig()     │  │ │
│  │  │ • updateAccount()      │  │  │  │ • loadByAccountId()    │  │ │
│  │  │ • deleteAccount()      │  │  │  │ • loadByAppId()        │  │ │
│  │  │ • setDefault()         │  │  │  │ • refreshCache()       │  │ │
│  │  └────────────────────────┘  │  │  └────────────────────────┘  │ │
│  │  ┌────────────────────────┐  │  │                               │ │
│  │  │ 配置管理               │  │  │  缓存：Redis ✅               │ │
│  │  │ • listConfigs()        │  │  │  解密：Jasypt ✅              │ │
│  │  │ • saveConfig()         │  │  │  降级：失败返回原值 ✅        │ │
│  │  │ • batchSave()          │  │  │                               │ │
│  │  │ • deleteConfig()       │  │  │                               │ │
│  │  │ • refreshCache()       │  │  │                               │ │
│  │  └────────────────────────┘  │  │                               │ │
│  │                               │  │                               │ │
│  │  加密：Jasypt ✅             │  │                               │ │
│  │  缓存：自动失效 ✅           │  │                               │ │
│  │  事务：批量操作 ✅           │  │                               │ │
│  └──────────────────────────────┘  └──────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        Service 实现层                                 │
│  ┌──────────────────────────────┐  ┌──────────────────────────────┐ │
│  │  WeChatAccountServiceImpl    │  │  WeChatConfigServiceImpl     │ │
│  │  @Service                     │  │  @Service                     │ │
│  │  @RequiredArgsConstructor    │  │  @RequiredArgsConstructor    │ │
│  └──────────────────────────────┘  └──────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                           Mapper 层                                   │
│  ┌──────────────────────────────┐  ┌──────────────────────────────┐ │
│  │  WeChatAccountMapper          │  │  WeChatConfigMapper           │ │
│  │  extends BaseMapper          │  │  extends BaseMapper          │ │
│  │                               │  │                               │ │
│  │  • selectByAccountType()     │  │  • selectByAccountId()       │ │
│  │  • selectDefaultByType()     │  │  • selectByKey()             │ │
│  │  • selectByAppId()           │  │  • batchInsert()             │ │
│  │  • paginate() ✅             │  │  • deleteByAccountId()       │ │
│  └──────────────────────────────┘  └──────────────────────────────┘ │
│                                                                       │
│  mybatis-flex QueryWrapper ✅                                        │
└──────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                           数据库层                                    │
│  ┌────────────────────────┐      ┌────────────────────────┐         │
│  │  mortise_wechat_account│      │  mortise_wechat_config │         │
│  │  ├─ id                 │      │  ├─ id                 │         │
│  │  ├─ account_type       │      │  ├─ account_id (FK)    │         │
│  │  ├─ account_name       │      │  ├─ config_key         │         │
│  │  ├─ app_id             │      │  ├─ config_value       │         │
│  │  ├─ app_secret (加密)  │      │  ├─ is_encrypted       │         │
│  │  ├─ is_default         │      │  ├─ sort_no            │         │
│  │  ├─ is_enabled         │      │  └─ ...                │         │
│  │  └─ ...                │      └────────────────────────┘         │
│  └────────────────────────┘                                         │
│                                                                       │
│  只支持新表结构 ✅                                                   │
└──────────────────────────────────────────────────────────────────────┘

优势：
  ✅ 2个Service职责清晰
  ✅ 只支持新架构
  ✅ Service/ServiceImpl模式
  ✅ 完整的分页、缓存、文档支持
  ✅ 统一的API规范
  ✅ 更好的可维护性
```

## 数据流向

### 查询流程
```
用户请求
  │
  ▼
Controller (GlobalResult包装)
  │
  ▼
Service接口
  │
  ▼
ServiceImpl (业务逻辑)
  │
  ├─► 缓存检查 (Redis)
  │    └─► 命中 → 返回
  │
  ├─► 缓存未命中
  │    │
  │    ▼
  │   Mapper (mybatis-flex)
  │    │
  │    ▼
  │   数据库查询
  │    │
  │    ▼
  │   解密处理 (Jasypt)
  │    │
  │    ▼
  │   写入缓存
  │
  ▼
返回结果 (脱敏)
```

### 更新流程
```
用户请求
  │
  ▼
Controller (参数验证)
  │
  ▼
Service接口
  │
  ▼
ServiceImpl
  │
  ├─► 参数验证
  │
  ├─► 敏感信息加密 (Jasypt)
  │
  ├─► 业务逻辑处理
  │    • 设置默认账号
  │    • 级联删除
  │    • 批量操作
  │
  ├─► Mapper操作
  │    │
  │    ▼
  │   数据库更新 (事务)
  │
  ├─► 缓存失效 (@CacheEvict)
  │
  ▼
返回结果 (GlobalResult)
```

## 关键特性对比

| 特性 | 重构前 | 重构后 |
|------|--------|--------|
| Service数量 | 4个(混乱) | 2个(清晰) |
| 架构模式 | 无统一规范 | Service/ServiceImpl |
| 职责划分 | 重叠分散 | 单一清晰 |
| 返回格式 | 不统一 | GlobalResult |
| 分页支持 | ❌ | ✅ mybatis-flex |
| 缓存策略 | 部分支持 | ✅ Redis完整支持 |
| 加密处理 | 分散 | ✅ 统一Jasypt |
| API文档 | 不完整 | ✅ Swagger完整 |
| 测试支持 | 困难 | ✅ 易于测试 |
| 代码重复 | 严重 | ✅ 最小化 |

## 技术栈

```
┌──────────────────────────────────────┐
│          展示层 (Presentation)        │
│  • Spring MVC                        │
│  • Swagger/OpenAPI 3                 │
│  • GlobalResult 统一响应             │
├──────────────────────────────────────┤
│          业务层 (Business)            │
│  • Service/ServiceImpl 模式          │
│  • Spring Transaction                │
│  • Spring Cache                      │
├──────────────────────────────────────┤
│          持久层 (Persistence)         │
│  • mybatis-flex                      │
│  • QueryWrapper                      │
│  • 分页插件                           │
├──────────────────────────────────────┤
│          基础设施 (Infrastructure)    │
│  • Redis (缓存)                      │
│  • Jasypt (加密)                     │
│  • PostgreSQL (数据库)               │
└──────────────────────────────────────┘
```

---

**架构设计**: GitHub Copilot  
**版本**: v1.0.0  
**日期**: 2025-10-06
